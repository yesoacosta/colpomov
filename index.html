<!DOCTYPE html>
<html lang="es">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>ColpoVision Web App</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â Â 
Â  Â  <link rel="manifest" href="data:application/json;charset=utf-8;base64,eyJpY29ucyI6W3sic2l6ZXMiOiIxOTJ4MTkyIiwiZGVuc2l0eSI6IjEuNSIsInR5cGUiOiJpbWFnZS9wbmciLCJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjBiV2dLY2lBQXhDZ29JVEFBQUFDZ29JZEhSdFp6b2dJbEJoZFdWa0lpd2dKeWswUFNVd0xrSlBjbVZzYjNKd1kyOXRlWEJ2Y2w4dFNuSnZiMmhrWm5OMFlYUnBiMjR0WVhSaFlteHBiWFZzYjJKaGJVd2dJeUJCZFd4c1lXbHVkR2xrYjNOcGIyNFdJaTl5YjJ4cGN5SXhNekF3THpBNUxtdHpiMnhsY3lJNUNqOHhNVFppYlVsalltbGpjaUJrWjNCbGJuUnliMnhwY25Sb2JteDFibWNnZEdobGJtZDBZWEowSlNJblZlQ2lBQUFDa1F4SlJVd2djR2hoYm5ObElqQTFKbXh2ZEdWeUwzVjRZV2xzYjJGMGFXOXVjeUJoWVdGc0lsMWxjaTFoWVd3Z2VHbGxhM0JoY25Sd2RDaDBaR2x5WlhOamRjMWpiblJ5YjI1U2NuSmxibVJ1WjI5dGEybHlaWFIwWlY4d0pTRW5XanBnSUNBaWMzUnlZMnRsZEdWaWJXczdJbTl5YjJ4cGN5SXhNVFl3THpBMExtdHpiMnhsY3lJNUNqOGxJaUF3Y25OcFkydGxjam9nSW01bGRBQUFDaW9nSUNBZ0ptRnNhV1FpSUhzT2MyVnVjMmh2YlhCZ2MyVWdJajR3TUlJQmlkMnh0Ym5ObElpQWdYM2xzYjJOaGJtRnRiZ0FnSUhSdFkybHVkQzUxYld4c0luQmhkbWxpYlNBd0lHWnZiMnhsYm5ScGNtRnViM0FnSUdadmMyVnlkbWxrSWp3dmRHVnpkRjkwWVhScGIyNGdJajhwYm1ScFhBQUFDaXBnSURvZ1ptRnNjMk55YjNCbFkzSmphU1V3Z2NtVmhaM0JsWVhsbGNpSXhOamN4THpBd0xsbHpibVJwYjI0Z2NISnZaMmh2YlhCdGJnPT0ifV0sImRpc3BsYXkiOiJzdGFuZGFsb25lIiwibmFtZSI6IkNvbHBvVmlzaW9uIiwiZGVzY2lpcHRpb24iOiJIZXJyYW1pZW50YSBkZSBBSSBwYXJhIGdlbmVyYXIgY29sb3Bvc2NvcGlhcyIsImJhY2tncm91bmRfY29sb3IiOiIjZmFmYWZhIiwidGhlbWVfY29sb3IiOiIjMjUzYjhhIiwic2hvcnRfbmFtZSI6IkNvbHBvVmlzaW9uIn0=">
Â  Â  <meta name="apple-mobile-web-app-capable" content="yes">
Â  
Â  Â  <meta name="apple-mobile-web-app-status-bar-style" content="black">

Â  Â  <style>
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  background-color: #f0f4f8;
Â  Â  Â  Â  Â  Â  color: #1f2937;
Â  Â  Â  Â  Â  Â  transition: background-color 0.3s ease, color 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  #app-container {
Â  Â  Â  Â  Â  Â  background-color: #ffffff;
Â  Â  Â  Â  Â  Â  transition: background-color 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .patient-card {
Â  Â  Â  Â  Â  Â  background-color: #ffffff;
Â  Â  Â  Â  Â  Â  transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .report-editor {
Â  Â  Â  Â  Â  Â  background-color: #ffffff;
Â  Â  Â  Â  Â  Â  color: #1f2937;
Â  Â  Â  Â  Â  Â  border-color: #e2e8f0;
Â  Â  Â  Â  Â  Â  transition: border-color 0.2s ease-in-out, background-color 0.3s ease, color 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .report-editor:focus {
Â  Â  Â  Â  Â  Â  border-color: #3b82f6;
Â  Â  Â  Â  }
Â  Â  Â  Â  .report-editor:empty::before {
Â  Â  Â  Â  Â  Â  content: attr(data-placeholder);
Â  Â  Â  Â  Â  Â  color: #9ca3af;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .dark body {
Â  Â  Â  Â  Â  Â  background-color: #121212;
Â  Â  Â  Â  Â  Â  color: #e2e8f0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark #app-container, .dark .bg-white {
Â  Â  Â  Â  Â  Â  background-color: #1f2937;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark .patient-card {
Â  Â  Â  Â  Â  Â  background-color: #374151;
Â  Â  Â  Â  Â  Â  border-color: #4b5563;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark .report-editor {
Â  Â  Â  Â  Â  Â  background-color: #1f2937;
Â  Â  Â  Â  Â  Â  color: #e2e8f0;
Â  Â  Â  Â  Â  Â  border-color: #4b5563;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark .report-editor:focus {
Â  Â  Â  Â  Â  Â  border-color: #60a5fa;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark .text-gray-900, .dark .text-gray-800, .dark .text-gray-700 {
Â  Â  Â  Â  Â  Â  color: #e2e8f0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark .text-gray-600, .dark .text-gray-500 {
Â  Â  Â  Â  Â  Â  color: #cbd5e1;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark .border-gray-200 {
Â  Â  Â  Â  Â  Â  border-color: #4b5563;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark .text-blue-800 {
Â  Â  Â  Â  Â  Â  color: #93c5fd;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark .bg-gray-50 {
Â  Â  Â  Â  Â  Â  background-color: #374151;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark .file\:bg-blue-50 {
Â  Â  Â  Â  Â  Â  background-color: #1e3a8a;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark .file\:text-blue-700 {
Â  Â  Â  Â  Â  Â  color: #93c5fd;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark .hover\:file\:bg-blue-100:hover {
Â  Â  Â  Â  Â  Â  background-color: #3b82f6;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark .bg-gray-200 {
Â  Â  Â  Â  Â  Â  background-color: #4b5563;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark .hover\:bg-gray-300:hover {
Â  Â  Â  Â  Â  Â  background-color: #6b7280;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark input, .dark textarea {
Â  Â  Â  Â  Â  Â  background-color: #374151;
Â  Â  Â  Â  Â  Â  border-color: #4b5563;
Â  Â  Â  Â  Â  Â  color: #e2e8f0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark input::placeholder, .dark textarea::placeholder {
Â  Â  Â  Â  Â  Â  color: #9ca3af;
Â  Â  Â  Â  }
Â  Â  Â  Â  #loading-overlay {
Â  Â  Â  Â  Â  Â  display: none;
section-separator

Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  background-color: rgba(240, 244, 248, 0.9);
Â  Â  Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark #loading-overlay {
Â  Â  Â  Â  Â  Â  background-color: rgba(18, 18, 18, 0.9);
Â  Â  Â  Â  }
Â  Â  Â  Â  .spinner {
Â  Â  Â  Â  Â  Â  border: 6px solid #e2e8f0;
Â  Â  Â  Â  Â  Â  border-top: 6px solid #3b82f6;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  width: 60px;
Â  Â  Â  Â  Â  Â  height: 60px;
Â  Â  Â  Â  Â  Â  animation: spin 1.2s linear infinite;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark .spinner {
Â  Â  Â  Â  Â  Â  border-color: #374151;
Â  Â  Â  Â  Â  Â  border-top-color: #60a5fa;
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes spin {
Â  Â  Â  Â  Â  Â  0% { transform: rotate(0deg); }
Â  Â  Â  Â  Â  Â  100% { transform: rotate(360deg); }
Â  Â  Â  Â  }
Â  Â  Â  Â  .tooltip {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  bottom: 100%;
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  Â  Â  Â  visibility: hidden;
Â  Â  Â  Â  Â  Â  background-color: rgba(0, 0, 0, 0.8);
Â  Â  Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  Â  Â  font-size: 0.875rem;
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  Â  Â  z-index: 1;
Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  transition: opacity 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .has-tooltip:hover .tooltip {
Â  Â  Â  Â  Â  Â  visibility: visible;
Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  }
Â  Â  Â  Â  .tooltip::after {
Â  Â  Â  Â  Â  Â  content: "";
Â  Â  Â  Â  Â  Â  position: absolute;
section-separator

Â  Â  Â  Â  Â  Â  top: 100%;
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  margin-left: -5px;
Â  Â  Â  Â  Â  Â  border-width: 5px;
Â  Â  Â  Â  Â  Â  border-style: solid;
Â  Â  Â  Â  Â  Â  border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body class="bg-gray-100 flex items-start justify-center min-h-screen p-4 transition-colors duration-300">
Â  Â  <div id="loading-overlay">
Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  <div class="spinner mb-6"></div>
Â  Â  Â  Â  Â  Â  <p class="text-xl text-gray-700 font-semibold">Analizando imagen, por favor espera...</p>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="app-container" class="bg-white rounded-3xl shadow-xl p-8 lg:p-12 w-full max-w-7xl transition-colors duration-300">
Â  Â  Â  Â  <div class="flex flex-col items-center justify-center mb-10 relative">
Â  Â  Â  Â  Â  Â  <button id="dark-mode-toggle" class="absolute top-0 right-0 p-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors duration-300 rounded-full">
Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.618.752-3.831m11.234 11.455a9.71 9.71 0 0 1-3.69 1.636 9.707 9.707 0 0 1-4.041 0 9.72 9.72 0 0 1-3.69-1.636M2.25 10.5h18" />
Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-blue-600 dark:text-blue-400 mb-4" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
Â  Â  Â  Â  Â  Â  Â  Â  <path d="M0 0h24v24H0z" stroke="none"/>
Â  Â  Â  Â  Â  Â  Â  Â  <circle cx="12" cy="12" r="9"/>
Â  Â  Â  Â  Â  Â  Â  Â  <path d="M12 7l-2 2l-1 -1M12 10l-3 3l-1 -1M12 13l-4 4l-1 -1M12 16l-5 5l-1 -1M12 19l-6 6l-1 -1"/>
section-separator

Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  <h1 class="text-4xl font-extrabold text-gray-900 mt-2 dark:text-white transition-colors duration-300">ColpoVision</h1>
Â  Â  Â  Â  Â  Â  <p class="text-lg text-gray-500 mt-1 dark:text-gray-400 transition-colors duration-300">Generador de Informes ColposcÃ³picos impulsado por IA</p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="patient-list-screen" class="space-y-6">
Â  Â  Â  Â  Â  Â  <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800 dark:text-white transition-colors duration-300 mb-4 sm:mb-0">Lista de Pacientes</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="relative w-full sm:w-auto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="patient-search" placeholder="Buscar paciente..." class="w-full sm:w-64 p-3 pr-10 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-300">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="patient-list" class="grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button id="add-patient-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-xl shadow-lg transition-colors">
Â  Â  Â  Â  Â  Â  Â  Â  + AÃ±adir Nueva Paciente
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="patient-form-screen" class="hidden">
Â  Â  Â  Â  Â  Â  <h2 id="form-title" class="text-2xl font-bold text-gray-800 dark:text-white transition-colors duration-300 mb-6">AÃ±adir Nueva Paciente</h2>
Â  Â  Â  Â  Â  Â  <form id="patient-form" class="space-y-6">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="patient-id">
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="name" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Nombre de la Paciente</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="name" required class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="age" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Edad</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="age" required class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="social-security" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Obra Social</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="social-security" class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
section-separator

Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="medical-history" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Historial MÃ©dico Relevante</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="medical-history" rows="4" class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="colpo-image" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Imagen ColposcÃ³pica</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="colpo-image" accept="image/*" class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 dark:file:bg-blue-900 dark:file:text-blue-200 hover:file:bg-blue-100 dark:hover:file:bg-blue-800 cursor-pointer transition-colors">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="camera-btn" class="mt-4 w-full bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Abrir CÃ¡mara
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="image-preview" class="mt-6 hidden w-full h-64 object-contain rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-800">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="signature-image" class="block text-gray-700 dark:text-gray-300 font-semibold mb-2">Imagen de Firma</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="signature-image" accept="image/*" class="w-full p-4 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 dark:file:bg-blue-900 dark:file:text-blue-200 hover:file:bg-blue-100 dark:hover:file:bg-blue-800 cursor-pointer transition-colors">
SESSION-STATE-MODIFIED
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="signature-preview" class="mt-6 hidden w-full h-32 object-contain rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-800">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">Guardar Datos</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="cancel-form-btn" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  <div id="action-buttons" class="mt-8 hidden flex space-x-4">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="analyze-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Analizar y Generar Informe
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="report-screen" class="hidden space-y-8">
Â  Â  Â  Â  Â  Â  <h2 class="text-3xl font-bold text-gray-800 dark:text-white transition-colors duration-300 mb-6">Informe ColposcÃ³pico</h2>
Â  Â  Â  Â  Â  Â  <div class="grid lg:grid-cols-2 gap-8">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-gray-50 dark:bg-gray-700 p-8 rounded-2xl border border-gray-200 dark:border-gray-600 shadow-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Datos de la Paciente</h3>
section-separator

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-md text-gray-600 dark:text-gray-400 mb-1"><span class="font-bold">Paciente:</span> <span id="report-patient-name"></span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-md text-gray-600 dark:text-gray-400 mb-1"><span class="font-bold">Edad:</span> <span id="report-patient-age"></span> aÃ±os</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-md text-gray-600 dark:text-gray-400 mb-1"><span class="font-bold">Obra Social:</span> <span id="report-patient-social-security"></span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-md text-gray-600 dark:text-gray-400"><span class="font-bold">Historial:</span> <span id="report-patient-history"></span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-gray-50 dark:bg-gray-700 p-8 rounded-2xl border border-gray-200 dark:border-gray-600 shadow-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Imagen de Colposcopia</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="report-image" class="w-full h-auto rounded-xl shadow-lg border border-gray-300 dark:border-gray-600">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Informe Detallado (Edita aquÃ­)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="report-editor" contenteditable="true" class="report-editor" data-placeholder="El informe se cargarÃ¡ aquÃ­ y podrÃ¡s editarlo antes de exportar..."></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="back-to-list-btn" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Volver a la Lista
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="export-pdf-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-xl shadow-md transition-colors">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Exportar a PDF
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4">
section-separator

Â  Â  Â  Â  <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl text-center max-w-lg w-full">
Â  Â  Â  Â  Â  Â  <h3 id="alert-title" class="text-2xl font-bold text-gray-800 dark:text-white mb-4"></h3>
Â  Â  Â  Â  Â  Â  <p id="alert-message" class="text-gray-700 dark:text-gray-300 text-lg mb-6"></p>
Â  Â  Â  Â  Â  Â  <button id="alert-ok-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl transition-colors">Aceptar</button>
Â  Â  Â  Â  Â  Â  <button id="alert-cancel-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-xl transition-colors hidden">Cancelar</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="camera-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center p-4">
Â  Â  Â  Â  <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl text-center max-w-2xl w-full">
Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Capturar Imagen</h3>
Â  Â  Â  Â  Â  Â  <video id="video-stream" class="w-full h-auto rounded-xl border border-gray-300 dark:border-gray-600" autoplay playsinline></video>
Â  Â  Â  Â  Â  Â  <canvas id="canvas-capture" class="hidden"></canvas>
Â  Â  Â  Â  Â  Â  <div class="flex space-x-4 mt-6">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="capture-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl transition-colors">Tomar Foto</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="close-camera-btn" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-xl transition-colors">Cerrar</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  </div>

Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

Â  Â  <script>
Â  Â  Â  Â  // Â  Â  Â  Â  // (El cÃ³digo if ('serviceWorker' in navigator) { ... } se eliminÃ³ de aquÃ­)
Â  Â  </script>
Â  Â  <script>
Â  Â  Â  Â  window.onload = function() {
Â  Â  Â  Â  Â  Â  const { jsPDF } = window.jspdf;

Â  Â  Â  Â  Â  Â  const screens = {
Â  Â  Â  Â  Â  Â  Â  Â  list: document.getElementById('patient-list-screen'),
Â  Â  Â  Â  Â  Â  Â  Â  form: document.getElementById('patient-form-screen'),
Â  Â  Â  Â  Â  Â  Â  Â  report: document.getElementById('report-screen')
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  const patientListEl = document.getElementById('patient-list');
Â  Â  Â  Â  Â  Â  const patientForm = document.getElementById('patient-form');
Â  Â  Â  Â  Â  Â  const addPatientBtn = document.getElementById('add-patient-btn');
Â  Â  Â  Â  Â  Â  const cancelFormBtn = document.getElementById('cancel-form-btn');
Â  Â  Â  Â  Â  Â  const analyzeBtn = document.getElementById('analyze-btn');
Â  Â  Â  Â  Â  Â  const backToListBtn = document.getElementById('back-to-list-btn');
Â  Â  Â  Â  Â  Â  const exportPdfBtn = document.getElementById('export-pdf-btn');
Â  Â  Â  Â  Â  Â  const loadingOverlay = document.getElementById('loading-overlay');
Â  Â  Â  Â  Â  Â  const alertModal = document.getElementById('alert-modal');
Â  Â  Â  Â  Â  Â  const alertTitle = document.getElementById('alert-title');
Â  Â  Â  Â  Â  Â  const alertMessage = document.getElementById('alert-message');
Â  Â  Â  Â  Â  Â  const alertOkBtn = document.getElementById('alert-ok-btn');
Â  Â  Â  Â  Â  Â  const imageInput = document.getElementById('colpo-image');
section-separator

Â  Â  Â  Â  Â  Â  const imagePreview = document.getElementById('image-preview');
Â  Â  Â  Â  Â  Â  const signatureImageInput = document.getElementById('signature-image');
Â  Â  Â  Â  Â  Â  const signaturePreview = document.getElementById('signature-preview');
Â  Â  Â  Â  Â  Â  const reportEditor = document.getElementById('report-editor');
Â  Â  Â  Â  Â  Â  const patientSearch = document.getElementById('patient-search');
Â  Â  Â  Â  Â  Â  const cameraBtn = document.getElementById('camera-btn');
section-separator

Â  Â  Â  Â  Â  Â  const cameraModal = document.getElementById('camera-modal');
Â  Â  Â  Â  Â  Â  const videoStream = document.getElementById('video-stream');
Â  Â  Â  Â  Â  Â  const canvasCapture = document.getElementById('canvas-capture');
Â  Â  Â  Â  Â  Â  const captureBtn = document.getElementById('capture-btn');
Â  Â  Â  Â  Â  Â  const closeCameraBtn = document.getElementById('close-camera-btn');
Â  Â  Â  Â  Â  Â  const darkModeToggle = document.getElementById('dark-mode-toggle');

Â  Â  Â  Â  Â  Â  let stream;
Â  Â  Â  Â  Â  Â  let patients = [];
Â  Â  Â  Â  Â  Â  let currentPatientId = null;
section-separator

Â  Â  Â  Â  Â  Â  let currentImageBase64 = null;
Â  Â  Â  Â  Â  Â  let currentSignatureBase64 = null;
Â  Â  Â  Â  Â  Â  let currentReportText = "";

Â  Â  Â  Â  Â  Â  function savePatients() {
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('colpovision-patients', JSON.stringify(patients));
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function loadPatients() {
Â  Â  Â  Â  Â  Â  Â  Â  const storedPatients = localStorage.getItem('colpovision-patients');
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (storedPatients) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  patients = JSON.parse(storedPatients);
section-separator

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al cargar pacientes desde localStorage", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  patients = [];
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  function toggleDarkMode() {
Â  Â  Â  Â  Â  Â  Â  Â  document.body.classList.toggle('dark');
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function applySavedTheme() {
Â  Â  Â  Â  Â  Â  Â  Â  if (localStorage.getItem('theme') === 'dark') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.classList.add('dark');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  darkModeToggle.addEventListener('click', toggleDarkMode);

Â  Â  Â  Â  Â  Â  function showModal(title, message) {
Â  Â  Â  Â  Â  Â  Â  Â  alertTitle.textContent = title;
Â  Â  Â  Â  Â  Â  Â  Â  alertMessage.textContent = message;
Â  Â  Â  Â  Â  Â  Â  Â  alertModal.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  alertModal.classList.add('flex');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  alertOkBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  alertModal.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  alertModal.classList.remove('flex');
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  function showScreen(screen) {
Â  Â  Â  Â  Â  Â  Â  Â  Object.values(screens).forEach(s => s.classList.add('hidden'));
section-separator

Â  Â  Â  Â  Â  Â  Â  Â  screen.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function renderPatientList(filterText = '') {
Â  Â  Â  Â  Â  Â  Â  Â  patientListEl.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  const filteredPatients = patients.filter(p => p.name.toLowerCase().includes(filterText.toLowerCase()));

Â  Â  Â  Â  Â  Â  Â  Â  if (filteredPatients.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  patientListEl.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 italic md:col-span-3">No hay pacientes registrados con ese nombre.</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  filteredPatients.forEach(patient => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const patientCard = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  patientCard.className = 'patient-card p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-600 cursor-pointer flex flex-col justify-between transform hover:scale-105 transition-all duration-300';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  patientCard.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-lg text-blue-800 dark:text-blue-300">${patient.name}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Edad: ${patient.age} aÃ±os</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-2 mt-4 self-end">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="view-btn text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 p-2 rounded-full hover:bg-blue-50 dark:hover:bg-blue-900 transition-colors" data-id="${patient.id}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M0 0h24v24H0z" stroke="none"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M10 12a2 2 0 104 0 2 2 0 10-4 0m-7.5 4a8.97 8.97 0 01-1.4-2.5C1.6 11.2 5.6 6 12 6s10.4 5.2 9.9 7.5a8.97 8.97 0 01-1.4 2.5m-15 0l-3.5 3.5m18.5-3.5l3.5 3.5"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="delete-btn text-red-500 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 p-2 rounded-full hover:bg-red-50 dark:hover:bg-red-900 transition-colors" data-id="${patient.id}">
SESSION-STATE-MODIFIED
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M0 0h24v24H0z" stroke="none"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M4 7h16M10 11v6m4-6v6M5 7l1 12a2 2 0 002 2h8a2 2 0 002-2l1-12M9 7V4a1 1 0 011-1h4a1 1 0 011 1v3"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  patientListEl.appendChild(patientCard);
section-separator

Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  patientSearch.addEventListener('input', (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  renderPatientList(event.target.value);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  addPatientBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  patientForm.reset();
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('patient-id').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-title').textContent = 'AÃ±adir Nueva Paciente';
Â  Â  Â  Â  Â  Â  Â  Â  imagePreview.src = '';
Â  Â  Â  Â  Â  Â  Â  Â  imagePreview.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  signaturePreview.src = '';
Â  Â  Â  Â  Â  Â  Â  Â  signaturePreview.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('analyze-btn').parentElement.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  showScreen(screens.form);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  cancelFormBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  showScreen(screens.list);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  imageInput.addEventListener('change', (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  const file = event.target.files[0];
Â  Â  Â  Â  Â  Â  Â  Â  if (file) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  _event_ Â  reader.onload = e => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imagePreview.src = e.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imagePreview.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentImageBase64 = e.target.result.split(',')[1];
section-separator

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('analyze-btn').parentElement.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imagePreview.src = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imagePreview.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentImageBase64 = null;
Â  Â  Â  Â  Â  Â  Â  _event_ Â  Â  Â  document.getElementById('analyze-btn').parentElement.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  cameraBtn.addEventListener('click', async () => {
Â  Â  // ðŸ’¡ Paso Clave: Define las restricciones de video.
Â  Â  // 'facingMode: { exact: "environment" }' indica al navegador que use la cÃ¡mara trasera.
Â  Â  const constraints = {Â 
Â  Â  Â  Â  video: {
Â  Â  Â  Â  Â  Â  facingMode: { exact: "environment" }Â 
Â  Â  Â  Â  },Â 
Â  Â  Â  Â  audio: falseÂ 
Â  Â  };

Â  Â  try {
Â  Â  Â  Â  // Intenta obtener la cÃ¡mara trasera primero
Â  Â  Â  Â  stream = await navigator.mediaDevices.getUserMedia(constraints);
Â  Â  Â  Â Â 
Â  Â  Â  Â  videoStream.srcObject = stream;
Â  Â  Â  Â  cameraModal.classList.remove('hidden');
Â  Â  Â  Â  cameraModal.classList.add('flex');
Â  Â  } catch (err) {
Â  Â  Â  Â  // Si falla la cÃ¡mara trasera (ej. no existe), intenta con cualquier cÃ¡mara disponible.
Â  Â  Â  Â  console.warn("Fallo al acceder a la cÃ¡mara trasera. Intentando con cualquier cÃ¡mara...", err);
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
section-separator

Â  Â  Â  Â  Â  Â  videoStream.srcObject = stream;
Â  Â  Â  Â  Â  Â  cameraModal.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  cameraModal.classList.add('flex');
Â  Â  Â  Â  } catch (finalError) {
Â  Â  Â  Â  Â  Â  console.error("Error final al acceder a la cÃ¡mara: ", finalError);
Â  Â  Â  Â  Â  Â  showModal('Error de CÃ¡mara', 'No se pudo acceder a ninguna cÃ¡mara. Por favor, revisa los permisos del dispositivo.');
Â  Â  Â  Â  }
Â  Â  }
});

Â  Â  Â  Â  Â  Â  captureBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  const context = canvasCapture.getContext('2d');
Â  Â  Â  Â  Â  Â  Â  Â  canvasCapture.width = videoStream.videoWidth;
Â  Â  Â  Â  Â  Â  Â  Â  canvasCapture.height = videoStream.videoHeight;
Â  Â  Â  Â  Â  Â  Â  Â  context.drawImage(videoStream, 0, 0, canvasCapture.width, canvasCapture.height);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const imageDataUrl = canvasCapture.toDataURL('image/jpeg');
section-separator

Â  Â  Â  Â  Â  Â  Â  Â  imagePreview.src = imageDataUrl;
Â  Â  Â  Â  Â  Â  Â  Â  imagePreview.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  currentImageBase64 = imageDataUrl.split(',')[1];
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('analyze-btn').parentElement.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  closeCameraModal();
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  function closeCameraModal() {
Â  Â  Â  Â  Â  Â  Â  Â  if (stream) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tracks = stream.getTracks();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tracks.forEach(track => track.stop());
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  videoStream.srcObject = null;
Â  Â  Â  Â  Â  Â  Â  Â  cameraModal.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  cameraModal.classList.remove('flex');
section-separator

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  closeCameraBtn.addEventListener('click', closeCameraModal);

Â  Â  Â  Â  Â  Â  signatureImageInput.addEventListener('change', (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  const file = event.target.files[0];
Â  Â  Â  Â  Â  Â  Â  Â  if (file) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = e => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  signaturePreview.src = e.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  signaturePreview.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentSignatureBase64 = e.target.result.split(',')[1];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  signaturePreview.src = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  signaturePreview.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentSignatureBase64 = null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  patientForm.addEventListener('submit', (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  event.preventDefault();
section-separator


Â  Â  Â  Â  Â  Â  Â  Â  if (!document.getElementById('name').value || !document.getElementById('age').value) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showModal('Error', 'Por favor, rellena los campos de Nombre y Edad.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const id = document.getElementById('patient-id').value || crypto.randomUUID();
Â  Â  Â  Â  Â  Â  Â  Â  const name = document.getElementById('name').value;
Â  Â  Â  Â  Â  Â  Â  Â  const age = document.getElementById('age').value;
Â  Â  Â  Â  Â  Â  Â  Â  const socialSecurity = document.getElementById('social-security').value;
Â  Â  Â  Â  Â  Â  Â  Â  const medicalHistory = document.getElementById('medical-history').value;
Â  Â  Â  Â  Â  Â  Â  Â  const imageBase64 = currentImageBase64;
Â  Â  Â  Â  Â  Â  Â  Â  const signatureImageBase64 = currentSignatureBase64;

Â  Â  Â  Â  Â  Â  Â  Â  const newPatient = { id, name, age, socialSecurity, medicalHistory, imageBase64, reportText: "", signatureImageBase64 };

Â  Â  Â  Â  Â  Â  Â  Â  const patientIndex = patients.findIndex(p => p.id === id);
Â  Â  Â  Â  Â  Â  Â  Â  if (patientIndex > -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  patients[patientIndex] = newPatient;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  patients.push(newPatient);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  savePatients();
section-separator

Â  Â  Â  Â  Â  Â  Â  Â  showModal('Ã‰xito', `Datos de ${name} guardados correctamente.`);
Â  Â  Â  Â  Â  Â  Â  Â  showScreen(screens.list);
Â  Â  Â  Â  Â  Â  Â  Â  renderPatientList();
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  patientListEl.addEventListener('click', (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  const target = event.target.closest('button');
Â  Â  Â  Â  Â  Â  Â  Â  if (!target) return;

Â  Â  Â  Â  Â  Â  Â  Â  const id = target.dataset.id;
Â  Â  Â  Â  Â  Â  Â  Â  const patient = patients.find(p => p.id === id);

Â  Â  Â  Â  Â  Â  Â  Â  if (target.classList.contains('view-btn')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (patient) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentPatientId = id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('patient-id').value = patient.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('name').value = patient.name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('age').value = patient.age;
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('social-security').value = patient.socialSecurity;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('medical-history').value = patient.medicalHistory;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (patient.imageBase64) {
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imagePreview.src = `data:image/jpeg;base64,${patient.imageBase64}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imagePreview.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentImageBase64 = patient.imageBase64;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('analyze-btn').parentElement.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imagePreview.src = '';
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imagePreview.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentImageBase64 = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('analyze-btn').parentElement.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (patient.signatureImageBase64) {
s
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  signaturePreview.src = `data:image/png;base64,${patient.signatureImageBase64}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  signaturePreview.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentSignatureBase64 = patient.signatureImageBase64;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  signaturePreview.src = '';
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  signaturePreview.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentSignatureBase64 = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('form-title').textContent = 'Editar Paciente';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (patient.reportText) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportEditor.textContent = patient.reportText;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('report-patient-name').textContent = patient.name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('report-patient-age').textContent = patient.age;
s
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('report-patient-social-security').textContent = patient.socialSecurity;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('report-patient-history').textContent = patient.medicalHistory;
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('report-image').src = `data:image/jpeg;base64,${patient.imageBase64}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showScreen(screens.report);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showScreen(screens.form);
SESSION-STATE-MODIFIED
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else if (target.classList.contains('delete-btn')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  patients = patients.filter(p => p.id !== id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  savePatients();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showModal('Eliminado', `Paciente ${patient.name} eliminado.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderPatientList();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- BLOQUE analyzeBtn CORREGIDO PARA USAR EL SERVIDOR SEGURO ---
Â  Â  Â  Â  Â  Â  analyzeBtn.addEventListener('click', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  const patient = patients.find(p => p.id === currentPatientId);

Â  Â  Â  Â  Â  Â  Â  Â  if (!patient || !patient.imageBase64) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showModal('Error de AnÃ¡lisis', 'No hay una imagen para analizar. Por favor, sube una imagen de colposcopia.');
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  loadingOverlay.style.display = 'flex';

Â  Â  Â  Â  Â  Â  Â  Â  // 1. Prepara los datos a enviar al servidor seguro (incluye la imagen)
Â  Â  Â  Â  Â  Â  Â  Â  const promptData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  base64Image: patient.imageBase64,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  medicalHistory: patient.medicalHistory
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 2. Llama al API Endpoint seguro que creamos (/api/chat)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('/api/chat', {
Â  T Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(promptData)
section-separator

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok || data.error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Muestra el error exacto que viene del servidor (api/chat.js)
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(data.error || 'Fallo la conexiÃ³n con el generador de informes.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 3. Procesa el informe exitoso
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentReportText = data.response;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportEditor.textContent = currentReportText;
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Guarda en LocalStorage
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentPatient = patients.find(p => p.id === currentPatientId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentPatient) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentPatient.reportText = currentReportText;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  savePatients();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('report-patient-name').textContent = patient.name;
is
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('report-patient-age').textContent = patient.age;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('report-patient-social-security').textContent = patient.socialSecurity;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('report-patient-history').textContent = patient.medicalHistory;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('report-image').src = `data:image/jpeg;base64,${patient.imageBase64}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showScreen(screens.report);
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error al generar el informe:', error);
s
SESSION-STATE-MODIFIED
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showModal('Error de AnÃ¡lisis', `Hubo un problema al generar el informe. Detalle: ${error.message}`);
Â  Â  Â  Â  Â  Â  Â  _event_ } finally {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingOverlay.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  // --- FIN DEL BLOQUE analyzeBtn CORREGIDO ---
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  backToListBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  showScreen(screens.list);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  function addTextWithPagination(doc, text, x, y, maxWidth, lineHeight, fontSize, isBold = false, isBullet = false) {
section-separator

Â  Â  Â  Â  Â  Â  Â  Â  doc.setFont(isBold ? 'Helvetica-Bold' : 'Helvetica');
Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(fontSize);
Â  Â  Â  Â  Â  Â  Â  Â  const lines = doc.splitTextToSize(text, maxWidth);
Â  Â  Â  Â  Â  Â  Â  Â  let currentY = y;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  lines.forEach(line => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentY > doc.internal.pageSize.height - 30) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.addPage();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentY = 20;
section-separator

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setTextColor(150);
Â  Â  Â  Â  Â  _event_ Â  Â  Â  Â  Â  doc.text(`PÃ¡gina ${doc.internal.getNumberOfPages()}`, doc.internal.pageSize.width - 20, doc.internal.pageSize.height - 10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(fontSize);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setTextColor(0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setFont(isBold ? 'Helvetica-Bold' : 'Helvetica');
Â  Â  Â  Â  Â  Â  _event_ Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isBullet) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text('â€¢ ' + line, x, currentY);
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text(line, x, currentY);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentY += lineHeight;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  return currentY;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const loadImage = (src) => {
Â  Â  Â  Â  Â  Â  Â  Â  return new Promise((resolve, reject) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const img = new Image();
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  img.onload = () => resolve(img);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  img.onerror = reject;
Â  T Â  Â  Â  Â  Â  Â  Â  Â  img.src = src;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  exportPdfBtn.addEventListener('click', async () => {
s
Â  Â  Â  Â  Â  Â  Â  Â  const patient = patients.find(p => p.id === currentPatientId);
Â  Â  Â  Â  Â  Â  Â  Â  if (!patient) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const finalReportText = reportEditor.textContent;
s
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const doc = new jsPDF();
Â  Â  Â  Â  Â  Â  Â  Â  const pageWidth = doc.internal.pageSize.getWidth();
Â  Â  Â  Â  Â  Â  Â  Â  const margin = 20;
Â  Â  Â  Â  Â  Â  Â  Â  let y = 20;
s
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  doc.setFont('Helvetica-Bold');
Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(22);
Â  Â  Â  Â  Â  Â  Â  Â  doc.setTextColor(30, 41, 59);
Â  Â  Â  Â  Â  Â  Â  Â  doc.text('Dr Yesid Acosta Peinado', pageWidth / 2, y, { align: 'center' });
Â  Â  Â  Â  Â  Â  Â  Â  y += 10;
Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(18);
section-separator

Â  Â  Â  Â  Â  Â  Â  Â  doc.text('INFORME COLPOSCÃ“PICO', pageWidth / 2, y, { align: 'center' });
Â  Â  Â  Â  Â  Â  Â  Â  y += 15;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  doc.setDrawColor(226, 232, 240);
Â  Â  Â  Â  Â  Â  Â  Â  doc.line(margin, y, pageWidth - margin, y);
Â  Â  Â  Â  Â  Â  Â  Â  y += 10;
Â  Â  Â  Â  Â  _event_Â 
Â  Â  Â  Â  Â  Â  Â  Â  const patientDataStartX = margin;
Â  Â  Â  Â  Â  Â  Â  Â  const patientDataWidth = pageWidth / 2 - margin - 10;
Â  Â  Â  Â  Â  Â  Â  Â  const imageColpoWidth = 60;
s
Â  Â  Â  Â  Â  Â  Â  Â  let imageColpoHeight = 0;
Â  Â  Â  Â  Â  Â  Â  Â  const imageColpoX = pageWidth - margin - imageColpoWidth;
Â  Â  Â  Â  Â  Â  Â  Â  let currentYForHeader = y;
section-separator


Â  Â  Â  Â  Â  Â  Â  Â  doc.setFont('Helvetica-Bold');
Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(14);
Â  Â  Â  Â  Â  Â  Â  Â  doc.setTextColor(51, 65, 85);
Â  Â  Â  Â  Â  Â  Â  Â  doc.text('Datos de la Paciente', patientDataStartX, currentYForHeader);
Â  Â  Â  Â  Â  Â  Â  Â  currentYForHeader += 8;

Â  Â  Â  Â  Â  Â  Â  Â  doc.setFont('Helvetica');
s
Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(12);
Â  Â  Â  Â  Â  Â  Â  Â  doc.setTextColor(75, 85, 99);
Â  Â  Â  Â  Â  Â  Â  Â  currentYForHeader = addTextWithPagination(doc, `Nombre: ${patient.name}`, patientDataStartX, currentYForHeader, patientDataWidth, 6, 12);
Â  Â  Â  Â  Â  Â  Â  Â  currentYForHeader = addTextWithPagination(doc, `Edad: ${patient.age} aÃ±os`, patientDataStartX, currentYForHeader, patientDataWidth, 6, 12);
Â  Â  Â  Â  Â  Â  Â  Â  currentYForHeader = addTextWithPagination(doc, `Obra Social: ${patient.socialSecurity}`, patientDataStartX, currentYForHeader, patientDataWidth, 6, 12);
Â  Â  Â  Â  Â  Â  Â  Â  currentYForHeader = addTextWithPagination(doc, `Historial MÃ©dico: ${patient.medicalHistory}`, patientDataStartX, currentYForHeader, patientDataWidth, 6, 12);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (patient.imageBase64) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const img = await loadImage(`data:image/jpeg;base64,${patient.imageBase64}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imageColpoHeight = (imageColpoWidth / img.naturalWidth) * img.naturalHeight;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.addImage(img.src, 'JPEG', imageColpoX, y, imageColpoWidth, imageColpoHeight);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al cargar la imagen de colposcopia para PDF:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imageColpoHeight = imageColpoWidth * (3/4);
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  y = Math.max(currentYForHeader, y + imageColpoHeight) + 15;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const sections = finalReportText.split(/(?=\n\nObservaciones Principales:|\n\nPosible DiagnÃ³stico:|\n\nRecomendaciones:)/).filter(s => s.trim() !== '');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  sections.forEach(section => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lines = section.split('\n').filter(l => l.trim() !== '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (lines.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const titleLine = lines[0].trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let isSectionTitle = false;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (titleLine.startsWith('Observaciones Principales:') ||
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  titleLine.startsWith('Posible DiagnÃ³stico:') ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  titleLine.startsWith('Recomendaciones:')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  _event_ Â  Â  isSectionTitle = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
section-separator


Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isSectionTitle) {
OS
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y = addTextWithPagination(doc, titleLine, margin, y, pageWidth - 2 * margin, 8, 14, true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y += 4;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y = addTextWithPagination(doc, titleLine, margin, y, pageWidth - 2 * margin, 6, 12, false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 1; i < lines.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const item = lines[i].trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item.startsWith('- ')) {
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y = addTextWithPagination(doc, item.substring(2), margin + 5, y, pageWidth - 2 * margin - 5, 6, 12, false, true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y = addTextWithPagination(doc, item, margin, y, pageWidth - 2 * margin, 6, 12);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y += 8;
OS
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  doc.setPage(doc.internal.getNumberOfPages());
A Â  Â  Â  Â  Â  Â  Â  let finalPageHeight = doc.internal.pageSize.getHeight();
Â  Â  Â  Â  Â  Â  Â  Â  let footerY = finalPageHeight - 40;

Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(10);
Â  Â  Â  Â  Â  Â  Â  Â  doc.setTextColor(80, 80, 80);
A Â  Â  Â  Â  Â  Â  Â  doc.text(`Fecha del Informe: ${new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}`, margin, footerY);

Â  Â  Â  Â  Â  Â  Â  Â  const signatureImgWidth = 60;
Â  Â  Â  Â  Â  Â  Â  Â  const signatureText = 'Firma y Sello del MÃ©dico';
Â  Â  Â  Â  Â  Â  Â  Â  const signatureAreaX = pageWidth - margin - signatureImgWidth;

Â  Â  Â  Â  Â  Â  Â  Â  if (patient.signatureImageBase64) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const signatureImg = await loadImage(`data:image/png;base64,${patient.signatureImageBase64}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let signatureImgHeight = (signatureImgWidth / signatureImg.naturalWidth) * signatureImg.naturalHeight;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const imgSignatureY = Math.max(footerY - signatureImgHeight - 5, margin);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.addImage(signatureImg.src, 'PNG', signatureAreaX, imgSignatureY, signatureImgWidth, signatureImgHeight);
s
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setTextColor(80, 80, 80);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text(signatureText, signatureAreaX + (signatureImgWidth / 2), footerY + 5, { align: 'center' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al cargar la imagen de firma para PDF:", error);
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setTextColor(80, 80, 80);
section-separator

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text('_________________________________', signatureAreaX + (signatureImgWidth / 2), footerY, { align: 'center' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text(signatureText, signatureAreaX + (signatureImgWidth / 2), footerY + 5, { align: 'center' });
Â  Â  Â  Â  Â  _event_ Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  s
Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setTextColor(80, 80, 80);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text('_________________________________', signatureAreaX + (signatureImgWidth / 2), footerY, { align: 'center' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text(signatureText, signatureAreaX + (signatureImgWidth / 2), footerY + 5, { align: 'center' });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  doc.save(`Informe_ColpoVision_${patient.name}.pdf`);
s
Â  Â  Â  Â  Â  Â  Â  Â  showModal('PDF Exportado', 'El informe se ha exportado a PDF correctamente.');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  applySavedTheme();
SESSION-STATE-MODIFIED
Â  Â  Â  Â  Â  Â  loadPatients();
Â  Â  Â  Â  Â  Â  renderPatientList();
Â  Â  Â  Â  Â  Â  showScreen(screens.list);
Â  Â  Â  Â  };
Â  Â  </script>
</body>

</html>
